import streamlit as st
import pandas as pd
from fpdf import FPDF
import base64
from datetime import datetime
import tempfile
import matplotlib.pyplot as plt
import matplotlib
matplotlib.use('Agg')
import os
import numpy as np

from .utils import format_indian_currency
from .procurement_report import generate_procurement_report

# --- Data Analysis Helpers ---

def classify_categories(df, grp_col="ITEM_NAME_GROUP"):
    """
    Classifies categories into High, Medium, Low value based on revenue.
    High: Top 70% cumulative value
    Medium: Next 20%
    Low: Bottom 10%
    """
    if grp_col not in df.columns:
        return pd.DataFrame()
        
    stats = df.groupby(grp_col).agg(
        Revenue=("AMOUNT", "sum"),
        Orders=("INVOICE_NO", "nunique")
    ).sort_values("Revenue", ascending=False)
    
    total_rev = stats["Revenue"].sum()
    stats["Share"] = (stats["Revenue"] / total_rev) * 100
    stats["CumShare"] = stats["Share"].cumsum()
    
    def get_class(cum_share):
        if cum_share <= 70: return "High Value"
        elif cum_share <= 90: return "Medium Value"
        else: return "Low Value"
        
    stats["Classification"] = stats["CumShare"].apply(get_class)
    
    # Correction: distinct cutoffs might put one item in High that bridges the gap.
    # Logic is fine for approximation.
    return stats

def analyze_consolidation(df, grp_col="ITEM_NAME_GROUP"):
    """
    Identifies Low Value categories with high order frequency (Fragmented).
    """
    if grp_col not in df.columns:
        return pd.DataFrame()
        
    stats = classify_categories(df, grp_col)
    if stats.empty: return stats
    
    # Filter for Low/Medium Value but High Frequency (e.g. above avg orders)
    avg_orders = stats["Orders"].mean()
    potential = stats[
        (stats["Classification"].isin(["Low Value", "Medium Value"])) & 
        (stats["Orders"] > avg_orders)
    ].copy()
    
    potential["Avg_Order_Value"] = potential["Revenue"] / potential["Orders"]
    return potential.sort_values("Orders", ascending=False)


# Wrapper for PDF compatibility (using Rs. instead of ‚Çπ symbol if needed, or ensuring font support)
# For FPDF, unicode '‚Çπ' might be tricky without specific fonts. Let's use 'Rs.' for PDF.
def format_currency_pdf(value):
    return format_indian_currency(value, "Rs.")

class PDF(FPDF):
    def header(self):
        # Executive Header Strip
        self.set_fill_color(33, 33, 33) # Dark Grey Background
        self.rect(0, 0, 210, 20, 'F')
        
        # Gold Accent Line
        self.set_fill_color(255, 215, 0) # Gold
        self.rect(0, 19, 210, 1, 'F')
        
        # Company Name / Logo
        self.set_font('Arial', 'B', 12)
        self.set_text_color(255, 255, 255)
        self.set_xy(10, 5)
        self.cell(0, 10, 'ELETTRO INTELLIGENCE', 0, 0, 'L')
        
        # Report Title Placeholder (will be set dynamically if possible, but static here generally works)
        # We can't easily pass variable data to header() without class props, so we keep it generic or rely on body title.
        self.set_font('Arial', '', 10)
        self.set_xy(0, 5)
        self.cell(200, 10, 'Executive Sales Report', 0, 0, 'R')
        
        self.ln(25) # Move cursor down below header

    def footer(self):
        self.set_y(-15)
        self.set_font('Arial', 'I', 8)
        self.set_text_color(128, 128, 128)
        self.cell(0, 10, f'CONFIDENTIAL | Page {self.page_no()} | Generated by ELETTRO Intelligence', 0, 0, 'C')

    def create_cover_page(self, customer_name, fy_list):
        self.add_page()
        
        # 1. Background Design (Right Strip)
        self.set_fill_color(33, 33, 33)
        self.rect(140, 0, 70, 297, 'F')
        
        self.set_fill_color(255, 215, 0) # Gold
        self.rect(138, 0, 2, 297, 'F')
        
        # 2. Main Title Area
        self.set_xy(10, 80)
        self.set_font("Arial", 'B', 32)
        self.set_text_color(33, 37, 41)
        self.multi_cell(120, 14, "DISTRIBUTOR\nSTRATEGY\nREPORT", 0, 'L')
        
        # 3. Subtitle / Customer Name
        self.ln(10)
        self.set_font("Arial", '', 16)
        self.set_text_color(100, 100, 100)
        self.cell(120, 10, "PREPARED FOR:", 0, 1)
        
        self.set_font("Arial", 'B', 20)
        self.set_text_color(218, 165, 32) # Dark Gold
        self.multi_cell(120, 10, str(customer_name).upper(), 0, 'L')
        
        # 4. Financial Year Context
        self.ln(10)
        self.set_font("Arial", '', 12)
        self.set_text_color(33, 33, 33)
        fy_str = " | ".join(fy_list)
        self.cell(120, 10, f"Analysis Period: {fy_str}", 0, 1)
        self.cell(120, 8, f"Generated: {datetime.now().strftime('%d %B %Y')}", 0, 1)
        
        # 5. Big Logo (if available) or Text in Dark Strip
        # Ideally upload a logo image here. For now text.
        self.set_xy(150, 120)
        self.set_text_color(255, 255, 255)
        self.set_font("Arial", 'B', 24)
        self.multi_cell(50, 12, "ELETTRO\nINTELLIGENCE", 0, 'R')
        
        self.set_xy(150, 250)
        self.set_font("Arial", '', 10)
        self.multi_cell(50, 5, "Strictly Private & Confidential\n\nFor Management Use Only", 0, 'R')

def create_chart(fig):
    # Apply professional styling before saving
    for ax in fig.get_axes():
        ax.spines['top'].set_visible(False)
        ax.spines['right'].set_visible(False)
        ax.grid(True, linestyle='--', alpha=0.6, color='#dddddd')
        ax.tick_params(axis='both', which='major', labelsize=10)
        
    with tempfile.NamedTemporaryFile(delete=False, suffix=".png") as tmp:
        # High DPI for clear printing
        fig.savefig(tmp.name, bbox_inches='tight', dpi=300, facecolor='white')
        return tmp.name

def generate_pdf(df, report_type, specific_entity=None):
    pdf = PDF()
    pdf.alias_nb_pages()
    pdf.add_page()
    pdf.set_auto_page_break(auto=True, margin=15)
    
    # --- Context & Title ---
    title_text = f"Report: {report_type}"
    sub_title = "Fiscal Year Overview"
    
    # Filter Data
    if specific_entity and specific_entity != "All":
        if report_type == "Customer Wise":
            df = df[df["CUSTOMER_NAME"] == specific_entity]
        elif report_type == "City Wise":
            col = "CITY" if "CITY" in df.columns else "STATE"
            df = df[df[col] == specific_entity]
        elif report_type == "Material Wise":
            col = "ITEMNAME" if "ITEMNAME" in df.columns else "MATERIALGROUP"
            df = df[df[col] == specific_entity]
        elif report_type == "Material Group Wise":
            col = "ITEM_NAME_GROUP" if "ITEM_NAME_GROUP" in df.columns else "MATERIALGROUP"
            df = df[df[col] == specific_entity]
        title_text = f"Profile: {str(specific_entity)[:50]}"
        sub_title = f"{report_type} Deep Dive"
    
    # Ensure we work on a copy to avoid SettingWithCopyWarning
    df = df.copy()

    # --- Page 1: Executive Dashboard ---
    
    # 1. Title Area
    pdf.set_text_color(33, 33, 33)
    pdf.set_font("Arial", 'B', 20)
    pdf.cell(0, 10, title_text.upper(), 0, 1, 'L')
    
    pdf.set_font("Arial", '', 11)
    pdf.set_text_color(100, 100, 100)
    pdf.cell(0, 8, f"{sub_title} | Generated: {datetime.now().strftime('%d %B %Y')}", 0, 1, 'L')
    pdf.ln(5)

    # 2. KPI Grid (Material Design Cards)
    total_rev = df["AMOUNT"].sum()
    total_orders = df["INVOICE_NO"].nunique()
    total_qty = df["QUANTITY"].sum() if "QUANTITY" in df.columns else 0
    avg_order = total_rev / total_orders if total_orders > 0 else 0

    pdf.set_font("Arial", 'B', 14)
    pdf.set_text_color(0, 0, 0)
    pdf.cell(0, 10, "1. Executive Summary", 0, 1)
    
    # Draw KPI Boxes (Simulated Cards)
    # We will use 4 columns
    col_width = 45
    box_height = 25
    y_start = pdf.get_y()
    
    metrics = [
        ("TOTAL REVENUE", format_currency_pdf(total_rev)),
        ("TOTAL ORDERS", f"{total_orders:,}"),
        ("TOTAL QUANTITY", f"{int(total_qty):,}"),
        ("AVG ORDER VALUE", format_currency_pdf(avg_order))
    ]
    
    for i, (label, value) in enumerate(metrics):
        x = 10 + (i * (col_width + 3)) # 3mm gap
        
        # Card Background (Light Grey)
        pdf.set_fill_color(248, 249, 250)
        pdf.rect(x, y_start, col_width, box_height, 'F')
        
        # Top Border (Gold)
        pdf.set_fill_color(218, 165, 32) # Goldenrod
        pdf.rect(x, y_start, col_width, 1, 'F')
        
        # Label
        pdf.set_xy(x, y_start + 4)
        pdf.set_font("Arial", 'B', 7)
        pdf.set_text_color(108, 117, 125) # Muted text
        pdf.cell(col_width, 5, label, 0, 0, 'C')
        
        # Value
        pdf.set_xy(x, y_start + 11)
        pdf.set_font("Arial", 'B', 11)
        pdf.set_text_color(33, 37, 41) # Dark text
        pdf.cell(col_width, 8, value, 0, 0, 'C')

    pdf.set_y(y_start + box_height + 10)

    # 3. Monthly Trend Graph
    if "MONTH" in df.columns:
        trend = df.groupby("MONTH")["AMOUNT"].sum().reset_index()
        
        # Sort chronologically
        try:
            trend["SortKey"] = pd.to_datetime(trend["MONTH"], format="%b-%y", errors='coerce')
            trend = trend.sort_values("SortKey")
        except:
            pass
            
        fig, ax = plt.subplots(figsize=(10, 4))
        ax.plot(trend["MONTH"], trend["AMOUNT"], marker='o', color='#FFD700', linewidth=2)
        ax.set_title("Monthly Revenue Trend", fontsize=12, fontweight='bold')
        ax.grid(True, linestyle='--', alpha=0.5)
        ax.set_xlabel("Month")
        ax.set_ylabel("Revenue")
        
        img_path = create_chart(fig)
        plt.close(fig)
        
        pdf.set_font("Arial", 'B', 12)
        pdf.cell(0, 10, "2. Revenue Trend", 0, 1)
        pdf.image(img_path, x=10, w=190)
        os.remove(img_path)
        pdf.ln(5)

        fig, ax = plt.subplots(figsize=(10, 4))
        # Clear background
        fig.patch.set_facecolor('white')
        ax.set_facecolor('white')
        
        ax.plot(trend["MONTH"], trend["AMOUNT"], marker='o', color='#B8860B', linewidth=2.5, markersize=8) # Dark Goldenrod
        ax.set_title("Monthly Revenue Trend", fontsize=14, fontweight='bold', pad=15)
        ax.set_xlabel("Month", fontsize=11, fontweight='bold')
        ax.set_ylabel("Revenue", fontsize=11, fontweight='bold')
        
        # Rotate Labels 45 Degrees
        plt.setp(ax.get_xticklabels(), rotation=45, ha="right", rotation_mode="anchor")
        
        # Add data labels (skip overlapping ones if too many)
        step = 1 if len(trend) < 15 else 2
        for i, (x, y) in enumerate(zip(trend["MONTH"], trend["AMOUNT"])):
            if i % step == 0:
                label = format_currency_pdf(y)
                ax.annotate(label, 
                            (x, y), 
                            textcoords="offset points", 
                            xytext=(0,10), 
                            ha='center', 
                            fontsize=8,
                            bbox=dict(boxstyle="round,pad=0.3", fc="white", ec="#dddddd", alpha=0.8))
        
        img_path = create_chart(fig)
        plt.close(fig)
        
        pdf.set_font("Arial", 'B', 12)
        pdf.cell(0, 10, "2. Revenue Trend", 0, 1)
        pdf.image(img_path, x=10, w=190)
        os.remove(img_path)
        pdf.ln(5)

    # --- Page 2: Category Analysis with Donut Chart ---
    pdf.add_page()
    
    # 4. Material Group Analysis (Donut Chart)
    grp_col = "ITEM_NAME_GROUP" if "ITEM_NAME_GROUP" in df.columns else "MATERIALGROUP"
    if grp_col in df.columns:
        pdf.set_font("Arial", 'B', 12)
        pdf.cell(0, 10, "3. Category Distribution", 0, 1)
        
        # Prepare Data: Top 5 + Others
        grp_data = df.groupby(grp_col)["AMOUNT"].sum().sort_values(ascending=False)
        if len(grp_data) > 5:
            top_5 = grp_data.head(5)
            others = pd.Series([grp_data.iloc[5:].sum()], index=["Others"])
            final_data = pd.concat([top_5, others])
        else:
            final_data = grp_data

        fig, ax = plt.subplots(figsize=(10, 6))
        # Clear background
        fig.patch.set_facecolor('white')
        ax.set_facecolor('white')
        
        # Gold based colors
        colors = plt.cm.YlOrBr(np.linspace(0.4, 0.9, len(final_data)))
        
        # Donut Chart with filtered labels
        def autopct_format(pct):
            return ('%1.1f%%' % pct) if pct > 4 else ''

        wedges, texts, autotexts = ax.pie(final_data, autopct=autopct_format, startangle=90, 
                                          colors=colors, wedgeprops=dict(width=0.4, edgecolor='w'),
                                          textprops={'fontsize': 10, 'weight': 'bold'}, pctdistance=0.85)
        
        # Legend Side
        ax.legend(wedges, final_data.index, title="Categories", loc="center left", bbox_to_anchor=(1, 0, 0.5, 1), fontsize=9)
        ax.set_title(f"Revenue by {grp_col}", fontsize=14, fontweight='bold', pad=20)
        
        img_path = create_chart(fig)
        plt.close(fig)
        
        pdf.image(img_path, x=10, w=180)
        os.remove(img_path)
        pdf.ln(5)

    # 5. Top Performers (Bar Chart)
    pdf.set_font("Arial", 'B', 12)
    entity_label = "Items" if "ITEMNAME" in df.columns else "Products"
    pdf.cell(0, 10, f"4. Top 10 {entity_label}", 0, 1)
    
    col_item = "ITEMNAME" if "ITEMNAME" in df.columns else "MATERIALGROUP"
    top_items = df.groupby(col_item)["AMOUNT"].sum().sort_values(ascending=False).head(10)
    
    fig, ax = plt.subplots(figsize=(10, 5))
    # Clear background
    fig.patch.set_facecolor('white')
    ax.set_facecolor('white')
    
    # Horizontal Bar Chart
    container = top_items.sort_values().plot(kind='barh', color='#333333', edgecolor='#FFD700', width=0.7, ax=ax)
    
    ax.set_title(f"Top 10 {entity_label} by Revenue", fontsize=14, fontweight='bold', pad=15)
    ax.set_xlabel("Revenue (INR)", fontsize=11, fontweight='bold')
    ax.set_ylabel(None)
    
    # Add data labels inside bars or at end
    for container in ax.containers:
        ax.bar_label(container, fmt=lambda x: format_currency_pdf(x), padding=5, fontsize=9)
        
    plt.tight_layout()
    
    img_path = create_chart(fig)
    plt.close(fig)
    
    pdf.image(img_path, x=10, w=190)
    os.remove(img_path)
    pdf.ln(10)
    
    # 6. Detailed Breakdown Table
    pdf.set_font("Arial", 'B', 14)
    pdf.cell(0, 10, "5. Detailed Breakdown", 0, 1)
    
    # Table Header (Dark Theme)
    pdf.set_font("Arial", 'B', 9)
    pdf.set_fill_color(33, 37, 41) # Dark Header
    pdf.set_text_color(255, 255, 255) # White Text
    pdf.cell(100, 10, "Item Description", 0, 0, 'L', 1)
    pdf.cell(45, 10, "Category", 0, 0, 'L', 1)
    pdf.cell(45, 10, "Revenue", 0, 1, 'R', 1)
    
    pdf.set_font("Arial", '', 9)
    pdf.set_text_color(0, 0, 0) # Reset to black
    
    # top 25 items for table
    detailed_data = df.groupby([col_item, grp_col])["AMOUNT"].sum().reset_index().sort_values(by="AMOUNT", ascending=False).head(25)
    
    fill = False
    for idx, row in detailed_data.iterrows():
        # Zebra Striping
        pdf.set_fill_color(248, 249, 250) if fill else pdf.set_fill_color(255, 255, 255)
        
        name = str(row[col_item])[:55]
        grp = str(row[grp_col])[:20]
        amt = format_currency_pdf(row["AMOUNT"])
        
        pdf.cell(100, 8, name, 0, 0, 'L', fill)
        pdf.cell(45, 8, grp, 0, 0, 'L', fill)
        pdf.cell(45, 8, amt, 0, 1, 'R', fill)
        fill = not fill
        
    pdf.ln(5)
    # Divider Line
    pdf.set_draw_color(200, 200, 200)
    pdf.line(10, pdf.get_y(), 200, pdf.get_y())
    pdf.ln(5)

    # --- Page 3: FY Analysis & Deep Dive ---
    pdf.add_page()
    
    # 7. FY Year-Over-Year Analysis
    if "FINANCIAL_YEAR" in df.columns:
        pdf.set_font("Arial", 'B', 14)
        pdf.cell(0, 10, "6. Fiscal Year (FY) Analysis", 0, 1)
        pdf.ln(2)

        # FY Summary Table
        fy_stats = df.groupby("FINANCIAL_YEAR").agg(
            Revenue=("AMOUNT", "sum"),
            Orders=("INVOICE_NO", "nunique")
        ).sort_index()

        pdf.set_font("Arial", 'B', 10)
        pdf.set_fill_color(33, 37, 41) # Dark Header
        pdf.set_text_color(255, 255, 255)
        pdf.cell(40, 10, "Fiscal Year", 0, 0, 'C', 1)
        pdf.cell(50, 10, "Total Revenue", 0, 0, 'C', 1)
        pdf.cell(40, 10, "Total Orders", 0, 0, 'C', 1)
        pdf.cell(50, 10, "YoY Growth", 0, 1, 'C', 1)
        
        pdf.set_font("Arial", '', 10)
        pdf.set_text_color(0, 0, 0)
        
        prev_rev = 0
        fill = False
        for fy, row in fy_stats.iterrows():
            # Zebra
            pdf.set_fill_color(248, 249, 250) if fill else pdf.set_fill_color(255, 255, 255)
            
            growth = ((row['Revenue'] - prev_rev) / prev_rev * 100) if prev_rev > 0 else 0
            growth_str = f"{growth:+.1f}%" if prev_rev > 0 else "-"
            
            pdf.cell(40, 8, fy, 0, 0, 'C', fill)
            pdf.cell(50, 8, format_currency_pdf(row['Revenue']), 0, 0, 'R', fill)
            pdf.cell(40, 8, str(row['Orders']), 0, 0, 'C', fill)
            pdf.cell(50, 8, growth_str, 0, 1, 'C', fill)
            prev_rev = row['Revenue']
            fill = not fill
        pdf.ln(5)

        # FY Comparison Chart (Multi-line)
        if "MONTH" in df.columns:
            # Create a pivot table for charting
            # We need Month Name (order) vs Revenue, Hue = FY
            # Extract month number/name for sorting
            df['Month_Num'] = pd.to_datetime(df['DATE']).dt.month
            df['Month_Name'] = pd.to_datetime(df['DATE']).dt.strftime('%b')
            
            # Aggregate
            fy_trend = df.groupby(['FINANCIAL_YEAR', 'Month_Num', 'Month_Name'])['AMOUNT'].sum().reset_index()
            # Sort by Month Num
            fy_trend.sort_values('Month_Num', inplace=True)
            
            fig, ax = plt.subplots(figsize=(10, 5))
            # Clear background
            fig.patch.set_facecolor('white')
            ax.set_facecolor('white')
            
            # Plot each FY as a separate line
            for fy in fy_trend['FINANCIAL_YEAR'].unique():
                data = fy_trend[fy_trend['FINANCIAL_YEAR'] == fy]
                ax.plot(data['Month_Name'], data['AMOUNT'], marker='o', label=fy, linewidth=2.5, markersize=6)
            
            ax.set_title("Year-Over-Year Revenue Trends", fontsize=14, fontweight='bold', pad=15)
            ax.legend(fontsize=10)
            ax.set_xlabel("Month", fontsize=11, fontweight='bold')
            ax.set_ylabel("Revenue", fontsize=11, fontweight='bold')
            
            # Rotate labels if needed
            plt.xticks(rotation=45)
            
            img_path = create_chart(fig)
            plt.close(fig)
            pdf.image(img_path, x=10, w=190)
            os.remove(img_path)
            pdf.ln(5)

    # 8. Material Group Deep Dive
    pdf.set_font("Arial", 'B', 14)
    pdf.cell(0, 10, "7. Material Group Deep Dive", 0, 1)
    pdf.ln(5)

    # Get data by group
    if grp_col in df.columns:
        group_summary = df.groupby(grp_col).agg(
            Total_Revenue=("AMOUNT", "sum"),
            Top_Item=(col_item, lambda x: x.mode()[0] if not x.mode().empty else "N/A"),
            Order_Count=("INVOICE_NO", "nunique")
        ).sort_values(by="Total_Revenue", ascending=False).head(8) # Top 8 groups to fit on page
        
        for group_name, row in group_summary.iterrows():
            pdf.set_font("Arial", 'B', 11)
            pdf.set_fill_color(33, 37, 41)
            pdf.set_text_color(255, 255, 255)
            pdf.cell(0, 8, f" {group_name}", 0, 1, 'L', 1)
            
            pdf.set_font("Arial", '', 10)
            pdf.set_text_color(0, 0, 0)
            
            rev_share = (row["Total_Revenue"] / total_rev) * 100
            
            # Details Row
            pdf.set_fill_color(248, 249, 250)
            details = (f" Revenue: {format_currency_pdf(row['Total_Revenue'])} ({rev_share:.1f}% Share) | "
                       f"Orders: {row['Order_Count']} | "
                       f"Best Seller: {str(row['Top_Item'])[:40]}")
            
            pdf.cell(0, 8, details, 0, 1, 'L', 1)
            pdf.ln(3)

    # 9. Customer Specific Enhancement: Material Group Preference
    if report_type == "Customer Wise":
        pdf.add_page()
        pdf.set_font("Arial", 'B', 14)
        pdf.cell(0, 10, "8. Material Group Preference", 0, 1)
        pdf.ln(5)
        
        # Group by Material Group
        mat_grp_data = df.groupby(grp_col)["AMOUNT"].sum().sort_values(ascending=False).head(15)
        
        pdf.set_font("Arial", 'B', 10)
        pdf.set_fill_color(33, 37, 41) # Dark Header
        pdf.set_text_color(255, 255, 255)
        pdf.cell(120, 10, "Material Group", 0, 0, 'L', 1)
        pdf.cell(50, 10, "Revenue", 0, 1, 'R', 1)
        
        pdf.set_font("Arial", '', 10)
        pdf.set_text_color(0, 0, 0)
        
        fill = False
        for grp, amt in mat_grp_data.items():
            # Zebra
            pdf.set_fill_color(248, 249, 250) if fill else pdf.set_fill_color(255, 255, 255)
            pdf.cell(120, 8, str(grp)[:60], 0, 0, 'L', fill)
            pdf.cell(50, 8, format_currency_pdf(amt), 0, 1, 'R', fill)
            fill = not fill

    # 10. Material Group Specific Enhancement: Top Customers
    if report_type == "Material Group Wise":
        pdf.add_page()
        pdf.set_font("Arial", 'B', 14)
        pdf.cell(0, 10, "8. Top 10 Customers", 0, 1)
        pdf.ln(5)
        
        # Group by Customer
        cust_data = df.groupby("CUSTOMER_NAME")["AMOUNT"].sum().sort_values(ascending=False).head(15)
        
        pdf.set_font("Arial", 'B', 10)
        pdf.set_fill_color(33, 37, 41) # Dark Header
        pdf.set_text_color(255, 255, 255)
        pdf.cell(120, 10, "Customer Name", 0, 0, 'L', 1)
        pdf.cell(50, 10, "Revenue", 0, 1, 'R', 1)
        
        pdf.set_font("Arial", '', 10)
        pdf.set_text_color(0, 0, 0)
        
        fill = False
        for cust, amt in cust_data.items():
            # Zebra
            pdf.set_fill_color(248, 249, 250) if fill else pdf.set_fill_color(255, 255, 255)
            pdf.cell(120, 8, str(cust)[:60], 0, 0, 'L', fill)
            pdf.cell(50, 8, format_currency_pdf(amt), 0, 1, 'R', fill)
            fill = not fill

    return pdf

def render_interactive_reports(df):
    """Interactive tabular reports ‚Äî Month-Wise, City-Wise, State-Wise."""
    
    tab_month, tab_city, tab_state = st.tabs(["Month-Wise", "City-Wise", "State-Wise"])
    
    # ‚îÄ‚îÄ MONTH-WISE ‚îÄ‚îÄ
    with tab_month:
        if "MONTH" not in df.columns:
            st.warning("Month data not available.")
        else:
            c1, c2 = st.columns(2)
            with c1:
                months = sorted(df["MONTH"].dropna().unique().tolist())
                sel_month = st.selectbox("Select Month:", ["All Months"] + months, key="rpt_month")
            with c2:
                customers = sorted(df["CUSTOMER_NAME"].dropna().unique().tolist()) if "CUSTOMER_NAME" in df.columns else []
                sel_cust = st.selectbox("Filter by Customer:", ["All Customers"] + customers, key="rpt_month_cust")
            
            filtered = df.copy()
            if sel_month != "All Months":
                filtered = filtered[filtered["MONTH"] == sel_month]
            if sel_cust != "All Customers":
                filtered = filtered[filtered["CUSTOMER_NAME"] == sel_cust]
            
            if filtered.empty:
                st.info("No data for this selection.")
            else:
                # KPI summary
                k1, k2, k3, k4 = st.columns(4)
                k1.metric("Revenue", format_indian_currency(filtered["AMOUNT"].sum()))
                k2.metric("Orders", f"{filtered['INVOICE_NO'].nunique():,}")
                k3.metric("Customers", f"{filtered['CUSTOMER_NAME'].nunique():,}" if "CUSTOMER_NAME" in filtered.columns else "--")
                k4.metric("Avg Order", format_indian_currency(filtered["AMOUNT"].sum() / max(filtered["INVOICE_NO"].nunique(), 1)))
                
                st.markdown("---")
                
                # Material group breakdown
                grp_col = "ITEM_NAME_GROUP" if "ITEM_NAME_GROUP" in filtered.columns else "MATERIALGROUP"
                if grp_col in filtered.columns:
                    st.markdown("#### Material Group Breakdown")
                    mg = filtered.groupby(grp_col).agg(
                        Revenue=("AMOUNT", "sum"),
                        Quantity=("QTY", "sum") if "QTY" in filtered.columns else ("AMOUNT", "count"),
                        Orders=("INVOICE_NO", "nunique")
                    ).sort_values("Revenue", ascending=False).reset_index()
                    
                    mg["Revenue"] = mg["Revenue"].apply(lambda x: format_indian_currency(x))
                    mg.index = range(1, len(mg) + 1)
                    st.dataframe(mg, use_container_width=True, height=400)
                
                # If customer selected, show item-level detail
                if sel_cust != "All Customers" and "ITEMNAME" in filtered.columns:
                    st.markdown(f"#### Item Detail for {sel_cust}")
                    items = filtered.groupby("ITEMNAME").agg(
                        Revenue=("AMOUNT", "sum"),
                        Quantity=("QTY", "sum") if "QTY" in filtered.columns else ("AMOUNT", "count"),
                    ).sort_values("Revenue", ascending=False).reset_index()
                    items["Revenue"] = items["Revenue"].apply(lambda x: format_indian_currency(x))
                    items.index = range(1, len(items) + 1)
                    st.dataframe(items, use_container_width=True, height=300)
    
    # ‚îÄ‚îÄ CITY-WISE ‚îÄ‚îÄ
    with tab_city:
        if "CITY" not in df.columns:
            st.warning("City data not available.")
        else:
            cities = sorted(df["CITY"].dropna().unique().tolist())
            sel_city = st.selectbox("Select City:", ["All Cities"] + cities, key="rpt_city")
            
            filtered = df.copy()
            if sel_city != "All Cities":
                filtered = filtered[filtered["CITY"] == sel_city]
            
            if filtered.empty:
                st.info("No data for this city.")
            else:
                # KPI summary
                k1, k2, k3 = st.columns(3)
                k1.metric("City Revenue", format_indian_currency(filtered["AMOUNT"].sum()))
                k2.metric("Customers", f"{filtered['CUSTOMER_NAME'].nunique():,}" if "CUSTOMER_NAME" in filtered.columns else "--")
                k3.metric("Orders", f"{filtered['INVOICE_NO'].nunique():,}")
                
                st.markdown("---")
                
                # Top 30 customers
                if "CUSTOMER_NAME" in filtered.columns:
                    st.markdown("#### Top 30 Customers")
                    top_cust = filtered.groupby("CUSTOMER_NAME").agg(
                        Revenue=("AMOUNT", "sum"),
                        Orders=("INVOICE_NO", "nunique")
                    ).sort_values("Revenue", ascending=False).head(30).reset_index()
                    top_cust["Revenue"] = top_cust["Revenue"].apply(lambda x: format_indian_currency(x))
                    top_cust.index = range(1, len(top_cust) + 1)
                    st.dataframe(top_cust, use_container_width=True, height=400)
                
                # Material group breakdown
                grp_col = "ITEM_NAME_GROUP" if "ITEM_NAME_GROUP" in filtered.columns else "MATERIALGROUP"
                if grp_col in filtered.columns:
                    st.markdown("#### Material Group Breakdown")
                    mg = filtered.groupby(grp_col).agg(
                        Revenue=("AMOUNT", "sum"),
                        Orders=("INVOICE_NO", "nunique")
                    ).sort_values("Revenue", ascending=False).reset_index()
                    mg["Revenue"] = mg["Revenue"].apply(lambda x: format_indian_currency(x))
                    mg.index = range(1, len(mg) + 1)
                    st.dataframe(mg, use_container_width=True, height=300)
    
    # ‚îÄ‚îÄ STATE-WISE ‚îÄ‚îÄ
    with tab_state:
        if "STATE" not in df.columns:
            st.warning("State data not available.")
        else:
            states = sorted(df["STATE"].dropna().unique().tolist())
            sel_state = st.selectbox("Select State:", ["All States"] + states, key="rpt_state")
            
            filtered = df.copy()
            if sel_state != "All States":
                filtered = filtered[filtered["STATE"] == sel_state]
            
            if filtered.empty:
                st.info("No data for this state.")
            else:
                # KPI summary
                k1, k2, k3, k4 = st.columns(4)
                k1.metric("State Revenue", format_indian_currency(filtered["AMOUNT"].sum()))
                k2.metric("Cities", f"{filtered['CITY'].nunique():,}" if "CITY" in filtered.columns else "--")
                k3.metric("Customers", f"{filtered['CUSTOMER_NAME'].nunique():,}" if "CUSTOMER_NAME" in filtered.columns else "--")
                k4.metric("Orders", f"{filtered['INVOICE_NO'].nunique():,}")
                
                st.markdown("---")
                
                # City breakdown within state
                if "CITY" in filtered.columns:
                    st.markdown("#### Revenue by City")
                    city_rev = filtered.groupby("CITY").agg(
                        Revenue=("AMOUNT", "sum"),
                        Customers=("CUSTOMER_NAME", "nunique") if "CUSTOMER_NAME" in filtered.columns else ("AMOUNT", "count"),
                        Orders=("INVOICE_NO", "nunique")
                    ).sort_values("Revenue", ascending=False).reset_index()
                    city_rev["Revenue"] = city_rev["Revenue"].apply(lambda x: format_indian_currency(x))
                    city_rev.index = range(1, len(city_rev) + 1)
                    st.dataframe(city_rev, use_container_width=True)
                
                # Top 30 customers
                if "CUSTOMER_NAME" in filtered.columns:
                    st.markdown("#### Top 30 Customers")
                    top_cust = filtered.groupby("CUSTOMER_NAME").agg(
                        Revenue=("AMOUNT", "sum"),
                        Orders=("INVOICE_NO", "nunique")
                    ).sort_values("Revenue", ascending=False).head(30).reset_index()
                    top_cust["Revenue"] = top_cust["Revenue"].apply(lambda x: format_indian_currency(x))
                    top_cust.index = range(1, len(top_cust) + 1)
                    st.dataframe(top_cust, use_container_width=True, height=400)
                
                # Material group breakdown
                grp_col = "ITEM_NAME_GROUP" if "ITEM_NAME_GROUP" in filtered.columns else "MATERIALGROUP"
                if grp_col in filtered.columns:
                    st.markdown("#### Material Group Breakdown")
                    mg = filtered.groupby(grp_col).agg(
                        Revenue=("AMOUNT", "sum"),
                        Orders=("INVOICE_NO", "nunique")
                    ).sort_values("Revenue", ascending=False).reset_index()
                    mg["Revenue"] = mg["Revenue"].apply(lambda x: format_indian_currency(x))
                    mg.index = range(1, len(mg) + 1)
                    st.dataframe(mg, use_container_width=True, height=300)
    
    st.markdown("---")

def render_reporting(df):
    st.subheader("üìÑ Industrial Executive Reporting")
    st.caption("Generate premium industrial-grade sales reports with Fiscal Year context.")
    
    c1, c2 = st.columns(2)
    with c1:
        report_type = st.selectbox("Report Type:", ["Distributor Strategy Report", "Customer Wise", "City Wise", "Material Wise", "Material Group Wise"])
    with c2:
        # Dynamic Filter
        options = ["All"]
        fy_list = []
        
        if report_type == "Distributor Strategy Report":
            # For Strategy Report, we need Customer + Comparison Years
            options = sorted(df["CUSTOMER_NAME"].unique().tolist())
            if "FINANCIAL_YEAR" in df.columns:
                fy_options = sorted(df["FINANCIAL_YEAR"].unique().tolist())
                fy_list = st.multiselect("Select Financial Years for Comparison:", fy_options, default=fy_options)
            else:
                st.info("Financial Year data missing.")
                
        elif report_type == "Customer Wise":
            options += sorted(df["CUSTOMER_NAME"].unique().tolist())
        elif report_type == "City Wise":
            col = "CITY" if "CITY" in df.columns else "STATE"
            options += sorted(df[col].dropna().unique().tolist())
        elif report_type == "Material Wise":
            col = "ITEMNAME" if "ITEMNAME" in df.columns else "MATERIALGROUP"
            options += sorted(df[col].dropna().unique().tolist())
        elif report_type == "Material Group Wise":
            col = "ITEM_NAME_GROUP" if "ITEM_NAME_GROUP" in df.columns else "MATERIALGROUP"
            options += sorted(df[col].dropna().unique().tolist())
            
        specific_entity = st.selectbox("Specific Entity:", options)

    if st.button("Generate Industrial PDF Report"):
        fname_entity = specific_entity if specific_entity != "All" else "Summary"
        with st.spinner("Generating Professional Report..."):
            try:
                pdf = None
                if report_type == "Distributor Strategy Report":
                     if specific_entity == "All":
                         st.error("Please select a specific customer for Strategy Report.")
                     else:
                         pdf = generate_distributor_strategy_report(df, specific_entity, fy_list)
                else:
                    pdf = generate_pdf(df, report_type, specific_entity)
                
                if pdf:
                    pdf_output = pdf.output(dest='S').encode('latin-1')
                    b64 = base64.b64encode(pdf_output).decode()
                    filename = f"ELETTRO_{report_type.replace(' ', '_')}_{fname_entity}.pdf"
                    
                    href = f'<a href="data:application/octet-stream;base64,{b64}" download="{filename}">' \
                           f'<button style="background-color:#333; color:#FFD700; border:2px solid #FFD700; padding:12px 24px; border-radius:5px; font-weight:bold; width:100%;">' \
                           f'‚¨áÔ∏è Download Industrial Report</button></a>'
                    st.markdown(href, unsafe_allow_html=True)
                    st.success("Report Ready!")
            except Exception as e:
                st.error(f"Error: {e}")

    # --- EXECUTIVE PROCUREMENT REPORT (PER CUSTOMER) ---
    st.markdown("---")
    st.subheader("üìä Executive Procurement Analysis")
    st.caption("Generate an 11-step, board-ready procurement analysis for any individual customer.")
    
    with st.expander("Configure Procurement Report"):
        # Customer selector ‚Äî report scoped to this customer's data only
        cust_list = sorted(df["CUSTOMER_NAME"].dropna().unique().tolist()) if "CUSTOMER_NAME" in df.columns else []
        proc_customer = st.selectbox("Select Customer (Dealer):", cust_list) if cust_list else None
        
        proc_supplier = st.text_input("Your Company / Supplier Name:", value="K.N. Elettro")
        
        if proc_customer:
            cust_preview = df[df["CUSTOMER_NAME"] == proc_customer]
            amt_col = "AMOUNT" if "AMOUNT" in cust_preview.columns else None
            if amt_col:
                st.info(
                    f"**{proc_customer}** ‚Äî "
                    f"{len(cust_preview):,} transactions | "
                    f"Total Spend: ‚Çπ{cust_preview[amt_col].sum():,.0f}"
                )
        
        if st.button("Generate Procurement Analysis (PDF)"):
            if not proc_customer:
                st.error("Please select a customer first.")
            else:
                with st.spinner(f"Analysing {proc_customer}'s procurement patterns..."):
                    try:
                        cust_df = df[df["CUSTOMER_NAME"] == proc_customer].copy()
                        pdf_path = generate_procurement_report(cust_df, proc_customer, proc_supplier)
                        
                        with open(pdf_path, "rb") as f:
                            pdf_data = f.read()
                        
                        b64 = base64.b64encode(pdf_data).decode()
                        safe_name = proc_customer.replace(' ', '_').replace('/', '-')
                        filename = f"PROCUREMENT_ANALYSIS_{safe_name}.pdf"
                        
                        href = f'<a href="data:application/octet-stream;base64,{b64}" download="{filename}">' \
                               f'<button style="background-color:#053f3c; color:#00ffa2; border:1px solid #00ffa2; padding:12px 24px; border-radius:5px; font-weight:bold; width:100%; margin-top: 10px;">' \
                               f'‚¨áÔ∏è Download Procurement Report ‚Äî {proc_customer}</button></a>'
                        st.markdown(href, unsafe_allow_html=True)
                        st.success("Analysis Complete!")
                    except Exception as e:
                        st.error(f"Error generating report: {e}")

    # --- ARCHIVE REPORTS TO LOCAL DISK ---
    st.markdown("---")
    st.subheader("üóÑÔ∏è Daily Archiving")
    
    if st.button("Generate & Archive Daily Reports"):
        with st.spinner("Generating and Archiving Reports locally..."):
            # Ensure folder exists
            date_str = datetime.now().strftime('%Y-%m-%d')
            folder_path = os.path.join(os.getcwd(), "reports", date_str)
            os.makedirs(folder_path, exist_ok=True)
            
            try:
                # 1. Executive Summary
                pdf1 = generate_pdf(df, "Material Group Wise", "All")
                fpath1 = os.path.join(folder_path, "Executive_Summary.pdf")
                pdf1.output(fpath1)
                
                # 2. Customer Overview
                pdf2 = generate_pdf(df, "Customer Wise", "All")
                fpath2 = os.path.join(folder_path, "Customer_Overview.pdf")
                pdf2.output(fpath2)
                
                st.success(f"‚úÖ Archived reports to: `{folder_path}`")
                st.balloons()
            except Exception as e:
                st.error(f"‚ùå Failed to archive: {e}")


# --- New Pages for Strategy Deck ---

def create_category_performance_page(pdf, df, grp_col):
    pdf.add_page()
    pdf.set_font("Arial", 'B', 16)
    pdf.cell(0, 10, "2. Category Performance Analysis", 0, 1)
    pdf.ln(5)
    
    # 1. Horizontal Bar Chart (Top 15) - Replacing Pareto
    top_cats = df.groupby(grp_col)["AMOUNT"].sum().sort_values(ascending=False).head(15)
    
    fig, ax = plt.subplots(figsize=(10, 5))
    fig.patch.set_facecolor('white')
    ax.set_facecolor('white')
    
    y_pos = np.arange(len(top_cats))
    ax.barh(y_pos, top_cats.values, color="#DAA520", height=0.6)
    ax.set_yticks(y_pos)
    ax.set_yticklabels([str(x)[:40] for x in top_cats.index], fontsize=8)
    ax.invert_yaxis()
    ax.set_xlabel("Revenue")
    ax.set_title("Top 15 Categories by Revenue", fontweight='bold')
    
    # Value Labels
    for i, v in enumerate(top_cats.values):
        ax.text(v, i, f" {format_currency_pdf(v)}", va='center', fontsize=7)
        
    img_path = create_chart(fig)
    plt.close(fig)
    pdf.image(img_path, x=10, w=190)
    os.remove(img_path)
    
    # 2. Detailed Performance Matrix (Top 15 table)
    pdf.ln(5)
    pdf.set_font("Arial", 'B', 12)
    pdf.cell(0, 10, "Category Performance Matrix (Top 15)", 0, 1)
    
    # Table Header
    pdf.set_font("Arial", 'B', 9)
    pdf.set_fill_color(220, 220, 220)
    pdf.cell(90, 8, "Category Name", 1, 0, 'L', 1)
    pdf.cell(35, 8, "Revenue", 1, 0, 'R', 1)
    pdf.cell(25, 8, "Orders", 1, 0, 'C', 1)
    pdf.cell(40, 8, "Avg Order Val", 1, 1, 'R', 1)
    
    pdf.set_font("Arial", '', 8)
    # Re-calc stats for table to get orders too
    stats = df.groupby(grp_col).agg(
        Revenue=("AMOUNT", "sum"),
        Orders=("INVOICE_NO", "nunique")
    ).sort_values("Revenue", ascending=False).head(15)
    
    for cat, row in stats.iterrows():
        aov = row["Revenue"] / row["Orders"] if row["Orders"] > 0 else 0
        pdf.cell(90, 7, str(cat)[:50], 1, 0, 'L')
        pdf.cell(35, 7, format_currency_pdf(row["Revenue"]), 1, 0, 'R')
        pdf.cell(25, 7, str(row["Orders"]), 1, 0, 'C')
        pdf.cell(40, 7, format_currency_pdf(aov), 1, 1, 'R')

def create_consolidation_page(pdf, df, grp_col):
    pdf.add_page()
    pdf.set_font("Arial", 'B', 16)
    pdf.cell(0, 10, "3. Efficiency & Consolidation Opportunities", 0, 1)
    pdf.ln(5)
    
    pdf.set_font("Arial", '', 10)
    pdf.multi_cell(0, 6, "The following analysis identifies 'High Frequency / Low Value' categories (Fragmented). Bundling these items can reduce logistical overhead and improve margins.", 0, 'L')
    pdf.ln(5)
    
    # 1. Scatter Plot (Frequency vs Value)
    stats = df.groupby(grp_col).agg(
        Revenue=("AMOUNT", "sum"),
        Orders=("INVOICE_NO", "nunique")
    ).reset_index()
    stats["AOV"] = stats["Revenue"] / stats["Orders"]
    
    # Filter out extreme outliers for better chart
    stats = stats[stats["Revenue"] > 0]
    
    fig, ax = plt.subplots(figsize=(10, 5))
    fig.patch.set_facecolor('white')
    ax.scatter(stats["Orders"], stats["AOV"], alpha=0.6, c="#FFD700", edgecolors='black')
    
    ax.set_title("Order Frequency vs. Average Order Value", fontweight='bold')
    ax.set_xlabel("Order Frequency (Count)")
    ax.set_ylabel("Average Order Value (INR)")
    ax.grid(True, linestyle='--', alpha=0.5)
    
    # Highlight Quadrant 4 (High Freq, Low Val)
    avg_ord = stats["Orders"].mean()
    avg_val = stats["AOV"].mean()
    
    ax.axvline(avg_ord, color='red', linestyle='--', alpha=0.5)
    ax.axhline(avg_val, color='red', linestyle='--', alpha=0.5)
    
    ax.text(avg_ord * 1.1, avg_val * 0.2, "Consolidation Zone\n(High Freq, Low Val)", color='red', fontsize=8)
    
    img_path = create_chart(fig)
    plt.close(fig)
    pdf.image(img_path, x=10, w=190)
    os.remove(img_path)
    
    # 2. Actionable List
    pdf.ln(5)
    pdf.set_font("Arial", 'B', 12)
    pdf.cell(0, 10, "Top 10 Consolidation Candidates", 0, 1)
    
    pdf.set_font("Arial", 'B', 9)
    pdf.set_fill_color(220, 220, 220)
    pdf.cell(100, 8, "Category Name", 1, 0, 'L', 1)
    pdf.cell(30, 8, "Order Freq", 1, 0, 'C', 1)
    pdf.cell(30, 8, "Avg Value", 1, 0, 'R', 1)
    pdf.cell(30, 8, "Recommendation", 1, 1, 'C', 1)
    
    pdf.set_font("Arial", '', 8)
    
    # Logic: High Freq (> Avg), Low Value (< Avg)
    candidates = stats[(stats["Orders"] > avg_ord) & (stats["AOV"] < avg_val)].sort_values("Orders", ascending=False).head(10)
    
    if candidates.empty:
        pdf.cell(0, 8, "No significant fragmentation detected.", 1, 1, 'C')
    else:
        for _, row in candidates.iterrows():
            pdf.cell(100, 7, str(row[grp_col])[:55], 1, 0, 'L')
            pdf.cell(30, 7, f"{row['Orders']:.0f}", 1, 0, 'C')
            pdf.cell(30, 7, format_currency_pdf(row["AOV"]), 1, 0, 'R')
            pdf.cell(30, 7, "BUNDLE", 1, 1, 'C')

def generate_distributor_strategy_report(df, customer_name, fy_list):
    """
    Generates a high-end strategy report (Dashboard Style) for a specific customer.
    """
    pdf = PDF()
    pdf.alias_nb_pages()
    
    # Filter Data
    cust_df = df[df["CUSTOMER_NAME"] == customer_name].copy()
    if fy_list:
        if "FINANCIAL_YEAR" in cust_df.columns:
            cust_df = cust_df[cust_df["FINANCIAL_YEAR"].isin(fy_list)]
    
    if cust_df.empty:
        return None

    grp_col = "ITEM_NAME_GROUP" if "ITEM_NAME_GROUP" in cust_df.columns else "MATERIALGROUP"

    # --- 1. Cover Page ---
    pdf.create_cover_page(customer_name, fy_list)
    
    # --- 2. Executive Dashboard (The One-Pager) ---
    pdf.add_page()
    
    # Grid Setup
    margin = 10
    page_width = 210
    content_width = page_width - (2 * margin)
    
    # A. Dashboard Header
    pdf.set_xy(margin, 10)
    pdf.set_font("Arial", 'B', 18)
    pdf.set_text_color(33, 33, 33)
    pdf.cell(content_width, 10, f"EXECUTIVE DASHBOARD: {str(customer_name)[:40].upper()}", 0, 1, 'L')
    
    pdf.set_font("Arial", '', 10)
    pdf.set_text_color(100, 100, 100)
    pdf.cell(content_width, 6, f"Period: {' | '.join(fy_list)}  |  Generated: {datetime.now().strftime('%d-%b-%Y')}", 0, 1, 'L')
    
    # Draw Line
    pdf.set_draw_color(255, 215, 0) # Gold
    pdf.set_line_width(0.5)
    pdf.line(margin, 28, page_width - margin, 28)
    
    # B. KPI Cards (Row 1) - y=35
    y_kpi = 35
    card_w = content_width / 4 - 2
    card_h = 25
    
    total_rev = cust_df["AMOUNT"].sum()
    total_orders = cust_df["INVOICE_NO"].nunique()
    if total_orders > 0:
        avg_order = total_rev / total_orders
    else:
        avg_order = 0
            
    # Find Top Category
    top_cat = cust_df.groupby(grp_col)["AMOUNT"].sum().idxmax() if not cust_df.empty else "N/A"
    
    metrics = [
        ("TOTAL REVENUE", format_currency_pdf(total_rev)),
        ("TOTAL ORDERS", f"{total_orders:,}"),
        ("AVG ORDER VALUE", format_currency_pdf(avg_order)),
        ("TOP CATEGORY", str(top_cat)[:15])
    ]
    
    for i, (label, val) in enumerate(metrics):
        x = margin + (i * (card_w + 2.6))
        
        # Card Bg
        pdf.set_fill_color(248, 249, 250)
        pdf.rect(x, y_kpi, card_w, card_h, 'F')
        
        # Left Strip (Gold)
        pdf.set_fill_color(218, 165, 32)
        pdf.rect(x, y_kpi, 1.5, card_h, 'F')
        
        # Label
        pdf.set_xy(x + 4, y_kpi + 4)
        pdf.set_font("Arial", 'B', 7)
        pdf.set_text_color(128, 128, 128)
        pdf.cell(card_w, 5, label, 0, 1)
        
        # Value
        pdf.set_xy(x + 4, y_kpi + 10)
        pdf.set_font("Arial", 'B', 12)
        pdf.set_text_color(33, 33, 33)
        pdf.cell(card_w, 8, val, 0, 0)

    # C. Charts Area (Row 2) - y=70
    y_charts = 70
    chart_h = 65
    chart_w = (content_width / 2) - 2
    
    # C1. Trend Chart (Left)
    if "MONTH" in cust_df.columns:
        trend = cust_df.groupby("MONTH")["AMOUNT"].sum().reset_index()
        try:
            trend["SortKey"] = pd.to_datetime(trend["MONTH"], format="%b-%y", errors='coerce')
            trend = trend.sort_values("SortKey")
        except: pass
        
        fig, ax = plt.subplots(figsize=(6, 4))
        fig.patch.set_facecolor('white')
        ax.set_facecolor('white')
        
        # Area Chart style
        ax.fill_between(trend["MONTH"], trend["AMOUNT"], color="#FFD700", alpha=0.3)
        ax.plot(trend["MONTH"], trend["AMOUNT"], color="#DAA520", linewidth=2, marker='o', markersize=4)
        
        ax.set_title("Monthly Revenue Trend", fontsize=10, fontweight='bold', loc='left')
        ax.tick_params(axis='x', rotation=45, labelsize=7)
        ax.tick_params(axis='y', labelsize=7)
        ax.set_xlabel(None)
        ax.spines['top'].set_visible(False)
        ax.spines['right'].set_visible(False)
        ax.grid(axis='y', linestyle=':', alpha=0.5)
        
        img_path = create_chart(fig)
        plt.close(fig)
        pdf.image(img_path, x=margin, y=y_charts, w=chart_w, h=chart_h)
        os.remove(img_path)
        
    # C2. Category Donut (Right)
    class_stats = classify_categories(cust_df, grp_col)
    if not class_stats.empty:
        fig, ax = plt.subplots(figsize=(6, 4))
        fig.patch.set_facecolor('white')
        
        # Top 5 + Others
        chart_data = class_stats.head(5)
        
        colors = ['#FFD700', '#DAA520', '#B8860B', '#F0E68C', '#EEE8AA']
        wedges, texts, autotexts = ax.pie(chart_data["Revenue"], labels=None, autopct='%1.0f%%', 
                                          startangle=90, colors=colors, pctdistance=0.85,
                                          wedgeprops=dict(width=0.4, edgecolor='white'))
        
        plt.setp(autotexts, size=8, weight="bold", color="black")
        
        # Legend
        ax.legend(wedges, chart_data.index, title="Top Categories", loc="center left", 
                  bbox_to_anchor=(1, 0, 0.5, 1), fontsize=7, title_fontsize=8, frameon=False)
        ax.set_title("Revenue Mix", fontsize=10, fontweight='bold', loc='center')
        
        img_path = create_chart(fig)
        plt.close(fig)
        pdf.image(img_path, x=margin + chart_w + 4, y=y_charts, w=chart_w, h=chart_h)
        os.remove(img_path)

    # D. Top Products & Insights (Row 3) - y=140
    y_row3 = 140
    
    # D1. Top Products Bar (Full Width)
    prod_h = 60
    
    top_prods = cust_df.groupby("ITEMNAME")["AMOUNT"].sum().sort_values(ascending=False).head(8)
    
    fig, ax = plt.subplots(figsize=(10, 3.5))
    fig.patch.set_facecolor('white')
    
    # Horizontal Bar
    y_pos = np.arange(len(top_prods))
    ax.barh(y_pos, top_prods.values, color="#333333", height=0.6)
    ax.set_yticks(y_pos)
    ax.set_yticklabels([str(x)[:30] for x in top_prods.index], fontsize=8)
    ax.invert_yaxis()  # labels read top-to-bottom
    
    ax.set_title("Top 8 Performing Products", fontsize=10, fontweight='bold', loc='left')
    ax.spines['top'].set_visible(False)
    ax.spines['right'].set_visible(False)
    ax.spines['bottom'].set_visible(False)
    ax.xaxis.set_visible(False) # Hide x axis
    
    # Direct Labeling
    for i, v in enumerate(top_prods.values):
        ax.text(v + (v*0.01), i, f" {format_currency_pdf(v)}", color='black', va='center', fontsize=8, fontweight='bold')
        
    img_path = create_chart(fig)
    plt.close(fig)
    pdf.image(img_path, x=margin, y=y_row3, w=content_width, h=prod_h)
    os.remove(img_path)
    
    # E. Strategic Insight Box (Row 4) - y=205
    y_row4 = 205
    box_h = 45
    
    # Auto-Insights
    high_val_count = len(class_stats[class_stats["Classification"] == "High Value"])
    opps = analyze_consolidation(cust_df, grp_col)
    opp_txt = "None identified."
    if not opps.empty:
        top_opp = opps.iloc[0].name
        opp_txt = f"Consider bundling '{top_opp}' (High Freq, Low Val) to improve margins."
        
    insight_text = (
        f"- GROWTH: {customer_name} remains a key partner with {format_currency_pdf(total_rev)} in revenue.\n"
        f"- PORTFOLIO: Business is driven by {high_val_count} core categories (High Value).\n"
        f"- OPPORTUNITY: {opp_txt}\n"
        f"- ACTION: Review {top_cat} inventory levels to ensure continuity."
    )
    
    # Insight Box Design
    pdf.set_xy(margin, y_row4)
    pdf.set_fill_color(240, 240, 240) # Light Grey
    pdf.set_draw_color(200, 200, 200)
    pdf.rect(margin, y_row4, content_width, box_h, 'DF')
    
    # Icon/Title
    pdf.set_xy(margin + 5, y_row4 + 5)
    pdf.set_font("Arial", 'B', 10)
    pdf.set_text_color(218, 165, 32)
    pdf.cell(0, 5, "Key Strategic Insights", 0, 1)
    
    # Text
    pdf.set_xy(margin + 5, y_row4 + 12)
    pdf.set_font("Arial", '', 9)
    pdf.set_text_color(50, 50, 50)
    pdf.multi_cell(content_width - 10, 6, insight_text)
    
    # --- 3. Category Performance Page ---
    create_category_performance_page(pdf, cust_df, grp_col)
    
    # --- 4. Consolidation & Efficiency Page ---
    create_consolidation_page(pdf, cust_df, grp_col)

    return pdf
